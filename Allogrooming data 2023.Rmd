---
title: "Allogrooming data 2023"
output: html_notebook
---
# mean and minimum grooming events/ bat
# matrix where grooming actor is row and recipient is column, and the cell has the number of grooming. csv or excel is fine. I know you have these data because it's your heatmap.

### Libraries
```{r libraries}
library(readxl)
library(ggplot2)
library(dplyr)
library(Rcpp)
library(tidyverse)
library(networkD3)
library(visNetwork)
library(htmlwidgets)

```

### Load data
```{r load data}
# bat names and states
v2022_bats <- read_excel("2022_vampire_data.xlsx", sheet = "bats")


# allogrooming data from security cams
v2022_allogr <- read_excel("2022_vampire_data.xlsx", 
    sheet = "Flight_cage", col_types = c("text", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "text", "text", "text", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "text", "text"))

# v2022_allogr <- read_excel("2022_vampire_data.xlsx", 
#     sheet = "Flight_cage", col_types = c("text", 
#         "text", "text", "numeric", "numeric", 
#         "numeric", "numeric", "text", "text", 
#         "text", "text", "text", "numeric", 
#         "numeric", "numeric", "numeric", 
#         "numeric", "numeric", "numeric", 
#         "text", "text", "text", "text"))
#View(v2022_allogr)

#allogrooming data from focal trials
v2022_focal <- read_excel("2022_vampire_data.xlsx", 
    sheet = "Focal_pruebas", col_types = c("text", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "text", "text", "text", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "text", "text", "text", 
        "numeric", "numeric"))

# v2022_focal  <- read_excel("2022_vampire_data.xlsx", 
#      sheet = "Focal_pruebas", col_types = c("text", 
#         "text", "text", "numeric", "numeric", 
#         "numeric", "numeric", "text", "text", 
#         "text", "text", "text", "numeric", 
#         "numeric", "numeric", "numeric", 
#         "numeric", "numeric", "numeric", 
#         "text", "text", "text", "text",
#         "text", "text", "text"))


# combine focal (fasting and non-fasting) and security camera data 
v2022_allogr <-
      bind_rows(v2022_allogr, v2022_focal)
view(v2022_allogr)
str(v2022_allogr)


#table with just the various bat names 
v2022_names <- v2022_bats %>% select(bat_name, formal_ID, new_formal_ID, source, deceased_premerge)


# rename to human readable names with year

      # add "juvenil" to v2022_names
v2022_names <- rbind(v2022_names, c("juvenil", "juvenil", "juvenil"))

      # add 22 to names (e.g. bea22), and a column with location attached as well 
v2022_names <- v2022_names %>% 
      mutate(bat_name_full = paste(bat_name, "22", sep="")) %>%
      mutate(l_bat_name_full = paste( sep = "_", source, bat_name_full))
view(v2022_names)

      #make long version of names by the names I want 
nameslong <- v2022_names %>%
  gather(ID_type, IDS, c(bat_name, formal_ID, new_formal_ID), na.rm = TRUE) %>%
  arrange(bat_name_full) %>%
      mutate(source = ifelse(bat_name_full == "raya22", "bayano", source)) #raya lived in bayano
nameslong


#dyads and triads that had previously met
premet_vamps <- read_excel("~/GitHub/proximity-sensors/merge/LTM dyads?.xlsx", 
    sheet = "ltm_dyad_or_triad")
```

#Make dataframe of all directed and undirected dyads and their group
```{r}
#missing <- data.frame(actor_name = bat_list, receiver_name = bat_list, n= 1)

#kick out deceased premerge bats and NA bats 
v2022_names_present <- v2022_names %>%
      filter(is.na(deceased_premerge)) %>%
      filter(!is.na(bat_name))

# make directed dyads with locations
dyads.d <- data.frame(loc_bata = v2022_names_present$l_bat_name_full, loc_batb = v2022_names_present$l_bat_name_full) %>% #make two columns with names
      complete(.,loc_bata, loc_batb) %>% #expand grid
      separate_wider_delim(loc_bata, "_", names = c("locA", "batA")) %>% #split column a
      separate_wider_delim(loc_batb, "_", names = c("locB", "batB")) %>% #split column b
      filter(batA != batB) %>% #kick out dyads with same bat %>%
      mutate(Dyad = paste(batA, batB, sep = "_"), 
             LocDyad = paste(locA, locB, sep = "_")) %>% #combine batA and B columns 
      relocate(Dyad, LocDyad)

#make directed dyads only between groups ("new" relationships)
dyads.d_new <- dyads.d %>%
      filter(locA != locB)  # will have to decide how to deal with males, who are listed as "captive.born" 
      
#make undirected dyads of all bats
dyads.u <- dyads.d %>%
      mutate(Dyad_undirected = ifelse(batA < batB, Dyad, paste(batB, batA, sep = "_")) ) %>% # directionless dyad
      relocate(Dyad_undirected) %>%
      mutate(Loc_undirected = ifelse(locA < locB, LocDyad, paste(locB, locA, sep = "_")) ) %>% #undirected groups
      group_by(Dyad_undirected) %>%
      slice_head(n=1) #only 1 row per undirected dyad
      #drop Dyad, group, and/or instead just take first of each

#make undirected dyads between groups ("new" relationships)



dyads.d # all directed dyads and their locations
dyads.d_new # all new directed dyads

```


### Cleaning 
```{r cleaning}


#make the text in actor and receiver lowercase (to match bat names)
v2022_allogr <- v2022_allogr %>% mutate(actor= tolower(actor), receiver = tolower(receiver)) 

#make the text in behavior lowercase (to be consistent)
v2022_allogr <- v2022_allogr %>% mutate(behavior= tolower(behavior)) 


      #join by actor to add actor names(match IDS and actor)
v2022_allogr <- v2022_allogr %>%
  left_join(nameslong, by = c("actor" = "IDS")) %>%
  select( - ID_type) %>%
      rename(actor_name = bat_name_full) %>%
      rename(l_actor_name = l_bat_name_full)


      # join by receiver to add receiver names
v2022_allogr <- v2022_allogr %>%
  left_join(nameslong, by = c("receiver" = "IDS")) %>%
  select( - ID_type) %>%
      rename(receiver_name = bat_name_full) %>%
      rename(l_receiver_name = l_bat_name_full) 
# txdld

#replace raya "capira" with "bayano"- her functional group
v2022_allogr<- 
      v2022_allogr %>%
      mutate(l_receiver_name = recode(l_receiver_name, "capira_raya22" = "bayano_raya22")) %>%
      mutate(l_actor_name = recode(l_actor_name, "capira_raya22" = "bayano_raya22"))

#remove rows where actor or receiver is NA
v2022_allogr <- v2022_allogr %>%
      filter(!is.na(actor)) %>%
      filter(!is.na(receiver))

#clean  groupnames
v2022_allogr %>% select(group) %>% unique()

v2022_allogr <- v2022_allogr %>% mutate(group = recode(
      group,
      "c" = "Chorrera",
      "t" ="Tolé",
      "b" = "Bayano", 
      "Tole" = "Tolé"
))


# Find odd cases/ typos
# cases where bat group was entered wrong

v2022_allogr <- v2022_allogr %>%
       mutate( group = replace(group, actor_name =="judy22", "Chorrera")) %>%
       mutate( group = replace(group, actor_name =="alanis22", "Chorrera")) %>%
       mutate( group = replace(group, actor_name == "isla22", "Bayano")) %>%
       mutate( group = replace(group, actor_name == "raya22", "Bayano")) %>%
      mutate( group = replace(group, actor_name == "helen22", "Chorrera")) %>%
      mutate( group = replace(group, actor_name == "zula22", "Tolé")) %>%
                     # isla and raya should always be labelled as bayano
                    #helen and d should both be in Chorrera, not "NA"
       filter(!(group== "Tolé" & actor_name == "bea22")) %>% # there are two rows where bea, a chorrera bat is marked as tole, and interacts iwth a tole bat, Tracy. Not sure what's going on, so dropping completely for now
       filter(!(actor_name== "zula22" & group == "Bayano")) #same for this row where zula (tole) in in Bayano


#find uilani and zula exmples

#
# v2022_allogr %>%
#            filter(is.na(group) & actor_name == "helen22" ) %>% #& group != "Chorrera")
#            select(group) %>% unique()

v2022_allogr %>%
      filter(group == "Chorrera" & actor_name == "zula22")

     
v2022_allogr %>%
      filter(actor_name == "nelly22" | receiver_name =="nelly22")


#make date column
v2022_allogr <- v2022_allogr %>%
      mutate(date = make_datetime(year = year, month = month, day = day)) 


```

### cleaning pt 2
```{r cleaning 2}

nrow(v2022_allogr) # # observations pre-cleaning

## remove rows where actor or receiver are NA
v2022_allogr <- v2022_allogr %>%
      filter(actor_name !="NA") %>%
      filter(receiver_name !="NA")

nrow(v2022_allogr) #1524 # observations with no NA

# remove rows where actor and receiver are the same 
v2022_allogr <- v2022_allogr[v2022_allogr$actor_name != v2022_allogr$receiver_name, ]



nrow(v2022_allogr) # 1359 # observations with no same receiver/actors

#observations without juveniles (not saves) #726
v2022_allogr %>% 
      filter(actor_name != "juvenil22") %>%
      filter(receiver_name != "juvenil22") %>% nrow() # observations with no juveniles

#Pull out names of living bats, no juveniles
living_bats <- 
      v2022_bats %>% select(bat_name, deceased_premerge) %>%
      filter( is.na(deceased_premerge)) %>%
      mutate(bat_name_full = paste0(bat_name, "22")) %>%
      select(-bat_name, -deceased_premerge) %>%
      filter(bat_name_full != "NA22") # removes juveniles, no names
       #keep only NA for deceased

# drop non-living bats, unnamed juveniles from grooming dataset
v2022_allogr <- 
      v2022_allogr %>%
      filter( actor_name %in% living_bats$bat_name_full) %>%
      filter( receiver_name %in% living_bats$bat_name_full) #%>%
      #filter(actor_name != "quen22" | actor_name != "olive22")
unique(v2022_allogr$actor_name)
unique(v2022_allogr$receiver_name)

# what behaviors are there? 
unique(v2022_allogr$behavior) # a number of these to clarify



nrow(v2022_allogr) #of observations with living bats alone
```

### Trade actor and receiver for mouthlicking: 
(When we score this, it is easiest to score who is doing the mouthlicking as the actor. But to think about who is actually receiving the blood, these need to be switched
```{r}


#values preswitch 
head(v2022_allogr %>%
      filter(behavior == "m"))
head(v2022_allogr %>%
      filter(behavior == "g"))

#use "which" (behavior = m) to find the row numbers to change, then  rev to swap the values in actor/ receiver
v2022_allogr[which(v2022_allogr$behavior == "m"), c("actor", "receiver")] <- rev(v2022_allogr[which(v2022_allogr$behavior == "m"), c("actor", "receiver")])

#same for actor name, and l actor name 
v2022_allogr[which(v2022_allogr$behavior == "m"), c("actor_name", "receiver_name")] <- rev(v2022_allogr[which(v2022_allogr$behavior == "m"), c("actor_name", "receiver_name")])


v2022_allogr[which(v2022_allogr$behavior == "m"), c("l_actor_name", "l_receiver_name")] <- rev(v2022_allogr[which(v2022_allogr$behavior == "m"), c("l_actor_name", "l_receiver_name")])



#checking values post switch (m should have changed, g should not)
head(v2022_allogr %>%
      filter(behavior == "m"))
head(v2022_allogr %>%
      filter(behavior == "g"))


```
## Making list of all the cross-group dyads that had previously met
```{r}

#convert from ID to names
#join by bat1 to add  names(match IDS and bat1)
premet_vamps <- premet_vamps %>%
  left_join(nameslong, by = c("bat1" = "IDS")) %>%
  select( - ID_type) %>%
      rename(batname_1 = bat_name_full) %>%
      rename(l_batname_1 = l_bat_name_full)

#join by bat2 to add  names(match IDS and bat1)
premet_vamps <- premet_vamps %>%
  left_join(nameslong, by = c("bat2" = "IDS")) %>%
  select( - ID_type) %>%
      rename(batname_2 = bat_name_full) %>%
      rename(l_batname_2 = l_bat_name_full)

#join by bat3 to add  names(match IDS and bat1)
premet_vamps <- premet_vamps %>%
  left_join(nameslong, by = c("bat3" = "IDS")) %>%
  select( - ID_type) %>%
      rename(batname_3 = bat_name_full) %>%
      rename(l_batname_3 = l_bat_name_full)

  

#replace raya "capira" with "bayano"- her functional group
# premet_vamps<- 
#      premet_vamps %>%
#       mutate(l_batname1 = recode(l_batname1, "capira_raya22" = "bayano_raya22")) %>%
#       mutate(l_batname2 = recode(l_batname2, "capira_raya22" = "bayano_raya22")) %>%
#        mutate(l_batname3 = recode(l_batname3, "capira_raya22" = "bayano_raya22"))


living_bats <- as.list(living_bats$bat_name_full)

#remove names of dead bats
premet_vamps <- premet_vamps %>%
  mutate(across(c(batname_1,batname_2,batname_3), ~ ifelse(. %in% as.list(living_bats), ., NA))) %>%
      select(-l_batname_1, -l_batname_2, -l_batname_3) %>%
      relocate(batname_1, batname_2, batname_3)

      
#next bit of script shows all  dyads instead of full triads
premet_vamps_long_a <- premet_vamps %>%
      pivot_longer(
            cols=c(batname_2, batname_3), 
            names_to = "interaction_role",
            values_to = "bat_b"
      ) %>%
      rename("bat_a" = batname_1) %>%
      relocate(bat_a, bat_b) %>%
      select(-interaction_role)

premet_vamps <-
      premet_vamps %>%
      select(-batname_1) %>%
      rename("bat_a" = batname_2, 
             "bat_b" = batname_3) %>%
      relocate(bat_a, bat_b) %>%
      rbind(premet_vamps_long_a) %>%
      mutate(across(c(bat_a,bat_b), ~ ifelse(. %in% c("maui22", "ube22"), NA, .))) %>% #these bats arrived later, were previous bats with same band ids
      filter(!if_any(c(bat_a,bat_b), is.na)) %>% #filter out rows where a bat is NA
      arrange(bat_a, bat_b) %>%
       distinct(.keep_all = TRUE) %>% #get rid of duplicate rows %>%
       mutate( bata_batb = paste(bat_a, bat_b, sep = "_")) %>% #first step undirected dyad
      mutate(bata_batb = ifelse(bat_a < bat_b, bata_batb, paste(bat_b, bat_a, sep = "_"))  ) %>% # directionless dyad
      relocate(bata_batb) %>%
      arrange(bata_batb) %>%
      rename( "source.b1" = source.x, 
              "source.b2" = source.y, 
              "source.b3"= source )#fix source labels
#write.csv(premet_vamps, file = "previously_met_vampires.csv")

time_spent_prev_vamps <- 
      premet_vamps %>%
      group_by(bata_batb) %>%
      summarize( days_together = sum(days)) %>%
      arrange(-days_together)
#write.csv(time_spent_prev_vamps, file = "time_spent_previous_vamps.csv")


time_spent_prev_vamps
premet_vamps

time_spent_prev_vamps %>%
      summarize( n_dyads = n(), mostdays = max(days_together), leastdays = min(days_together))
#write.csv(obs_pair, file = paste0("observations_pairs_", Behavior,  ".csv", sep =""))
```

Most recent date bats have been together
```{r}
#least and most recent date cross-group dyads were together
premet_vamps %>%
      summarize(mostrecent = max(date_end), leastrecent = min(date_end))

#bats involved in these cross-group dyads
unique(c(premet_vamps$bat_a, premet_vamps$bat_b))

#number of bats involved in these cross-group dyads
length(unique(c(premet_vamps$bat_a, premet_vamps$bat_b)))

```
#### Cleaning done###

### Number of Observations per individual
```{r Obs per individual}


# of observations with usable data
nrow(v2022_allogr) 

# observations per individual by whether actor/ receiver/ interaction

obs_per_individual <- v2022_allogr %>%
      pivot_longer(
            cols= c(l_actor_name, l_receiver_name), 
            names_to = "interaction_role", 
            values_to = "subject"
      ) %>%
      relocate(subject, interaction_role) %>% 
          group_by( subject) %>% #remove group #group,
      summarize (total= n(),
                 actor = sum(interaction_role=="l_actor_name"),
                 receiver = sum(interaction_role=="l_receiver_name"),
                 grooming = sum(behavior=="g", na.rm = TRUE),
                 mouthlicking = sum(behavior=="m", na.rm = TRUE),
                 aggression = sum(behavior=="x", na.rm = TRUE) #, 
                 #copulation = sum(behavior=="c", na.rm = TRUE)
                 ) %>%
      arrange( -total) #group,



write.csv(obs_per_individual, file = "obs_per_individual.csv")
obs_per_individual
```

# Matrix where grooming actor is row and recipient is column, and the cell has the number of grooming. 
# same for mouthlicking
#accuracy 
#Observation edge list     
```{r obs matrix}
#basic matrix of all observations
# come back and fix 
obs_pair_all_m <- v2022_allogr %>%
      filter(behavior == "m") %>%
      group_by(l_actor_name,l_receiver_name) %>%  # or : v2022_allogr %>% count(actor,receiver )
      summarise(n = n()) %>% 
      arrange(-n) %>%
     # group_by(group) %>%
      ungroup() %>%
      complete(.,l_actor_name, l_receiver_name, fill = list(n=0)) #fill in missing combinations within group
      # fill in NA,s with 0
# remove rows where actor and receiver are the same      
obs_pair_all_m <- obs_pair_all_m[obs_pair_all_m$l_actor_name != obs_pair_all_m$l_receiver_name, ]  


#by group
unique(v2022_allogr$actor_name)
example_obs_pair <- v2022_allogr %>%
      mutate(actor_name = as.factor(actor_name), receiver_name = as.factor(receiver_name)) %>% 
      filter(behavior == "m") %>% #, .preserve = TRUE
      group_by(actor_name,receiver_name) %>%  # or : #group
      count(actor_name,receiver_name ) %>%
     # summarise(n = n()) %>% 
      arrange(-n) %>%
      #group_by(group) %>%
      ungroup() %>%
      complete(actor_name, receiver_name, fill = list(n=0)) #fill in missing combinations within group
      # fill in NA,s with 0
# remove rows where actor and receiver are the same      
example_obs_pair <- obs_pair[obs_pair$actor_name != obs_pair$receiver_name, ]  



# mutate(ID = factor(ID, levels = letters)) %>%
#  count(ID, name = "no_rows", .drop = F) 

# select only grooming edge list, and only mouthlicking edge list (should also do this for duration, rather than instances)
#  create matrix of # observations from each actor and receiver

ObsMatrix <- function( data = data, Behavior) {
      
      
obs_pair <- data %>%
      filter(behavior == Behavior, .preserve = TRUE) %>% #remove preserve = true if it breaks 
      group_by(actor_name,receiver_name) %>%  # or : v2022_allogr %>% count(actor,receiver ) #group
      summarise(n = n()) %>% 
      arrange(-n) %>%
     # group_by(group) %>%
      ungroup() %>%
      complete(actor_name, receiver_name, fill = list(n=0)) #fill in missing combinations within group
      # fill in NA,s with 0
# remove rows where actor and receiver are the same      
obs_pair <- obs_pair[obs_pair$actor_name != obs_pair$receiver_name, ]  

#this is the edgelist 
     


write.csv(obs_pair, file = paste0("observations_pairs_", Behavior,  ".csv", sep =""))


#arrange by group
# obs_pair <- obs_pair %>%
#       arrange(group)

return(obs_pair)
      
}

bat_list <- unique(obs_pair_grooming$actor_name) #base for finding missing values

#for adding missing bats
missing <- data.frame(actor_name = bat_list, receiver_name = bat_list, n= 1)

 
#all interactions     
obs_pair_mouthlicking <- ObsMatrix(data = v2022_allogr, Behavior = "m")      
obs_pair_mouthlicking <-rbind(obs_pair_mouthlicking, c("maui22", "maui22", 1)) %>% #to compensate for losing Maui
 mutate(n= as.integer(n))  %>%
complete(actor_name, receiver_name, fill = list(n=0))  #fill in missing combinations within group%>%
#filter(actor_name != receiver_name)
obs_pair_mouthlicking 
write.csv(obs_pair_mouthlicking, "directed_n_observations_mouthlicking_dyad.csv")

obs_pair_grooming <- ObsMatrix(data = v2022_allogr, Behavior = "g")  
obs_pair_grooming
write.csv(obs_pair_grooming, "directed_n_observations_grooming_dyad.csv")

obs_pair_aggression <- ObsMatrix(data = v2022_allogr, Behavior = "x") 
obs_pair_aggression <- rbind(missing, obs_pair_aggression) %>%
      complete(actor_name, receiver_name, fill = list(n=0))  #fill in missing combinations within group%>%
write.csv(obs_pair_aggression, "directed_n_observations_aggression_dyad.csv")
#filter(actor_name != receiver_name) 
      
obs_pair_aggression
# code for adding missing new <- 

#premerge interactions

obs_pair_mouthlicking_premerge <- v2022_allogr %>%
      filter(date < "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "m") 
obs_pair_mouthlicking_premerge<- rbind(missing, obs_pair_mouthlicking_premerge) %>%
      complete(actor_name, receiver_name, fill = list(n=0))  #fill in missing combinations within group%>%
#filter(actor_name != receiver_name) 

obs_pair_grooming_premerge <- v2022_allogr %>%
      filter(date < "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "g")



obs_pair_aggression_premerge <- v2022_allogr %>%
      filter(date < "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "x")
obs_pair_aggression_premerge<- rbind(missing, obs_pair_aggression_premerge) %>%
      complete(actor_name, receiver_name, fill = list(n=0)) #%>% #fill in missing combinations within group%>%
#filter(actor_name != receiver_name) 
 
#post merge interactions

obs_pair_mouthlicking_postmerge <- v2022_allogr %>%
      filter(date > "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "m") 
obs_pair_mouthlicking_postmerge<- rbind(missing, obs_pair_mouthlicking_postmerge) %>%
      complete(actor_name, receiver_name, fill = list(n=0)) #%>% #fill in missing combinations within group%>%
#filter(actor_name != receiver_name) 

obs_pair_grooming_postmerge <- v2022_allogr %>%
      filter(date > "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "g") 


obs_pair_aggression_postmerge <- v2022_allogr %>%
      filter(date > "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "x")
obs_pair_aggression_postmerge<- rbind(missing, obs_pair_aggression_postmerge) %>%
      complete(actor_name, receiver_name, fill = list(n=0)) #fill in missing combinations within group%>%
#filter(actor_name != receiver_name) 

```
# list with ID and group of all individuals, sorted alphabetically
```{r}
bat_groups <- 
      obs_per_individual %>%
      select(subject) %>%
       separate_wider_delim(subject, delim = "_", names = c("group", "bat_name_full")) %>%
      arrange(bat_name_full) %>%
      relocate(bat_name_full) %>%
      mutate(color = recode(group, "bayano" = "#D32F27", "chorrera"= "#178B76", "tole" = "#EDB81D", "captive.born"= "gray"))




  "#178B76"

"#EDB81D"
"#D32F27"


"#C82B27"

"#BC4B2E"
```


#function for making matrix
```{r, edgelist to matrix}
a_b_edgelist_to_matrix <- function(el=el, symbol="_", directed= T, make.NA.zero=T){
  a <- str_split(as.data.frame(el)[,1],symbol, simplify = TRUE)[,1]
  r <- str_split(as.data.frame(el)[,1],symbol, simplify = TRUE)[,2]
  y <- as.data.frame(el)[,2]
  e <- data.frame(a,r,y, stringsAsFactors = F)
  require(igraph)
  if (make.NA.zero){
    g <- graph_from_data_frame(e, directed=directed)
    m <- get.adjacency(g, attr='y', sparse=FALSE)
    m
  }else{
    e$y <- e$y+1 # temporarily add one to distinguish between 0 and NA
    g <- graph_from_data_frame(e, directed=directed)
    m <- get.adjacency(g, attr='y', sparse=FALSE)
    m[m==0] <- NA # relabel missing values as NA
    m <- m-1 # subtract one to adjust values back
    m
    }
}
####
##edits##
a_b_edgelist_to_matrix <- function(a= el$a, r= el$r, y= el$y, make.NA.zero=T){
  a <- a #actor
  r <- r #receiver
  y <- y # response variable/ # interactions
  e <- data.frame(a,r,y, stringsAsFactors = F)
  require(igraph)
  if (make.NA.zero){
    g <- graph_from_data_frame(e)
    m <- get.adjacency(g, attr='y', sparse=FALSE)
    m
  }else{
    e$y <- e$y+1 # temporarily add one to distinguish between 0 and NA
    g <- graph_from_data_frame(e)
    m <- get.adjacency(g, attr='y', sparse=FALSE)
    m[m==0] <- NA # relabel missing values as NA
    m <- m-1 # subtract one to adjust values back
    m
   # g
    }
}


EL<- obs_pair 
```


## plotting

## grooming total
```{r, matrix}
#matrix of interactions for all indivduals
vamp_matrix <- a_b_edgelist_to_matrix( a= EL$actor_name, r= EL$receiver_name, y=EL$n ) 
vamp_matrix
write.csv(vamp_matrix, paste("vamp_matrix_",  ".csv", sep = ""))

#grooming all 
vamp_matrix_grooming <- a_b_edgelist_to_matrix( a= obs_pair_grooming$actor_name, r= obs_pair_grooming$receiver_name, y=obs_pair_grooming$n ) #EL here is obs_pair..
vamp_matrix_grooming
write.csv(vamp_matrix_grooming, paste("vamp_matrix_grooming",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_grooming <- 
      obs_pair_grooming %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 

#need to delete extras to make it fit hwen plotting (edge_colors_zero <- filter(n!=0 )), and keep only the color column


#maybe I need to delete the 0 values? 
obs_pair_grooming_nozero <- obs_pair_grooming %>%
      filter(n!=0) #remove edges that don't exist


g_g <- graph_from_data_frame(obs_pair_grooming_nozero, directed = TRUE) #can change to 
V(g_g) #get all vertices
V(g_g)$group <- bat_groups$group
V(g_g)$color <- bat_groups$color
V(g_g)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_g)$name) #14
V(g_g)$sex[match(c("maui22"), V(g_g)$name)] <- "M" # match(c("maui22"), V(g_g)$name) pulls Maui
V(g_g)$sex[match(c("ube22"), V(g_g)$name)] <- "M"
#E(g_g)$width <- scale(E(g_g)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_g)$color <- obs_pair_grooming_nozero$color
V(g_g)$label.cex <- 1.2
V(g_g)$label.color <- "black"
#V(g_g)$label.family <- "sans"
V(g_g)$shape = recode(V(g_g)$sex, F= "circle", M = "rectangle")
#V(g_g)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_g) #layout_with_kk(g_g) # layout_with_drl(g_g)  

#graph_attr(g_g)

#plotting

#saving plot
svg("grooming_network.svg", 7, 7)
#png("grooming_network.png", 600, 600)

grooming_network <- 
      plot(g_g,
     layout= layout,
     vertex.label.dist = 2.2,
    # label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_g)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

grooming_network 
 



#play with different package, visnetwork, later. 
visIgraph(g_g)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_g), file = "full_grooming.html")

to_vis <- toVisNetworkData(g_g)
groom_nodes <- to_vis$nodes
groom_edges <- to_vis$edges
width <- groom_edges$width
groom_nodes <- groom_nodes %>% select( !font.size, !font.color, !shape, !label)
groom_edges <- groom_edges %>% select(!width)
visNetwork_try <- visNetwork(groom_nodes, groom_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")



# other network things 
degree(g_g) #degree
# evcent(g_g) #eigenvector centrality
edge_betweenness(g_g) #betweenness centrality: centrality to the network, shortest distance between conntections
#page_rank()







#goals: color by group
#weight edges by # groomed
#make spacing better
#make font better
#graph_from_adjacency_matrix?
#obs pair before date
#obs pair after date
#grooming, mouthlicking aggression


```
#grooming pre-merge
```{r}

#grooming all 
vamp_matrix_grooming_premerge <- a_b_edgelist_to_matrix( a= obs_pair_grooming_premerge$actor_name, r= obs_pair_grooming_premerge$receiver_name, y=obs_pair_grooming_premerge$n) #EL here is obs_pair..

vamp_matrix_grooming_premerge
write.csv(vamp_matrix_grooming_premerge, paste("vamp_matrix_grooming_premerge",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_grooming_premerge <- 
      obs_pair_grooming_premerge %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 


#maybe I need to delete the 0 values? 
obs_pair_grooming_premerge_nozero <- obs_pair_grooming_premerge %>%
      filter(n!=0) #remove edges that don't exist


g_g_pre <- graph_from_data_frame(obs_pair_grooming_premerge_nozero, directed = TRUE) #can change to 
V(g_g_pre) #get all vertices
V(g_g_pre)$group <- bat_groups$group
V(g_g_pre)$color <- bat_groups$color
V(g_g_pre)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_g_pre)$name) #14
V(g_g_pre)$sex[match(c("maui22"), V(g_g_pre)$name)] <- "M" # match(c("maui22"), V(g_g_pre)$name) pulls Maui
V(g_g_pre)$sex[match(c("ube22"), V(g_g_pre)$name)] <- "M"
#E(g_g_pre)$width <- scale(E(g_g_pre)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_g_pre)$color <- obs_pair_grooming_premerge_nozero$color
V(g_g_pre)$label.cex <- 1.2
V(g_g_pre)$label.color <- "black"
#V(g_g_pre)$label.family <- "sans"
V(g_g_pre)$shape = recode(V(g_g_pre)$sex, F= "circle", M = "rectangle")
#V(g_g_pre)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_g_pre) #layout_with_kk(g_g_pre) # layout_with_drl(g_g_pre)  

#graph_attr(g_g_pre)

#plotting

#saving plot
svg("grooming_network_premerge.svg", 7, 7)
#png("grooming_network_premerge.png", 600, 600)

grooming_network_premerge <- 
      plot(g_g_pre,
     layout= layout,
     vertex.label.dist = 2.2,
    # label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_g_pre)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

grooming_network_premerge 
 



#play with different package, visnetwork, later. 
visIgraph(g_g_pre)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_g_pre), file = "grooming_premerge.html") 

to_vis <- toVisNetworkData(g_g_pre)
groom_nodes <- to_vis$nodes
groom_edges <- to_vis$edges
width <- groom_edges$width
groom_nodes <- groom_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
groom_edges <- groom_edges %>% select(!width)
visNetwork_try <- visNetwork(groom_nodes, groom_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

```



#grooming post-merge
```{r}

#grooming all 
vamp_matrix_grooming_postmerge <- a_b_edgelist_to_matrix( a= obs_pair_grooming_postmerge$actor_name, r= obs_pair_grooming_postmerge$receiver_name, y=obs_pair_grooming_postmerge$n) #EL here is obs_pair..

vamp_matrix_grooming_postmerge
write.csv(vamp_matrix_grooming_postmerge, paste("vamp_matrix_grooming_postmerge",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_grooming_postmerge <- 
      obs_pair_grooming_postmerge %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 


#maybe I need to delete the 0 values? 
obs_pair_grooming_postmerge_nozero <- obs_pair_grooming_postmerge %>%
      filter(n!=0) #remove edges that don't exist


g_g_post <- graph_from_data_frame(obs_pair_grooming_postmerge_nozero, directed = TRUE) #can change to 
V(g_g_post) #get all vertices
V(g_g_post)$group <- bat_groups$group
V(g_g_post)$color <- bat_groups$color
V(g_g_post)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_g_post)$name) #14
V(g_g_post)$sex[match(c("maui22"), V(g_g_post)$name)] <- "M" # match(c("maui22"), V(g_g_post)$name) pulls Maui
V(g_g_post)$sex[match(c("ube22"), V(g_g_post)$name)] <- "M"
#E(g_g_post)$width <- scale(E(g_g_post)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_g_post)$color <- obs_pair_grooming_postmerge_nozero$color
V(g_g_post)$label.cex <- 1.2
V(g_g_post)$label.color <- "black"
#V(g_g_post)$label.family <- "sans"
V(g_g_post)$shape = recode(V(g_g_post)$sex, F= "circle", M = "rectangle")
#V(g_g_post)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_g_post) #layout_with_kk(g_g_post) # layout_with_drl(g_g_post)  

#graph_attr(g_g_post)

#plotting

#saving plot
svg("grooming_network_postmerge.svg", 7, 7)
#png("grooming_network_postmerge.png", 600, 600)

grooming_network_postmerge <- 
      plot(g_g_post,
     layout= layout,
     vertex.label.dist = 2.2,
      #vertex.label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_g_post)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

grooming_network_postmerge 
 



#play with different package, visnetwork, later. 
visIgraph(g_g_post)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_g_post), file = "grooming_postmerge.html")

to_vis <- toVisNetworkData(g_g_post)
groom_nodes <- to_vis$nodes
groom_edges <- to_vis$edges
width <- groom_edges$width
groom_nodes <- groom_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
groom_edges <- groom_edges %>% select(!width)
visNetwork_try <- visNetwork(groom_nodes, groom_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

```

## mouthlicking total
```{r, matrix}
####
#try to see if it is possible to feed a lit of all bats , even if 0 observances of behavior in that bat

#mouthlicking all 
vamp_matrix_mouthlicking <- a_b_edgelist_to_matrix( a= obs_pair_mouthlicking$actor_name, r= obs_pair_mouthlicking$receiver_name, y=obs_pair_mouthlicking$n ) #EL here is obs_pair..
vamp_matrix_mouthlicking
write.csv(vamp_matrix_mouthlicking, paste("vamp_matrix_mouthlicking",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_mouthlicking <- 
      obs_pair_mouthlicking %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 
 
unique(obs_pair_mouthlicking$actor_name)
  

#need to delete extras to make it fit hwen plotting (edge_colors_zero <- filter(n!=0 )), and keep only the color column


#maybe I need to delete the 0 values? 
obs_pair_mouthlicking_nozero <- obs_pair_mouthlicking %>%
      filter(n!=0) #remove edges that don't exist


g_m <- graph_from_data_frame(obs_pair_mouthlicking_nozero, directed = TRUE) #can change to 
V(g_m) #get all vertices
V(g_m)$group <- bat_groups$group
V(g_m)$color <- bat_groups$color
V(g_m)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_m)$name) #14
V(g_m)$sex[match(c("maui22"), V(g_m)$name)] <- "M" # match(c("maui22"), V(g_m)$name) pulls Maui
V(g_m)$sex[match(c("ube22"), V(g_m)$name)] <- "M"
#E(g_m)$width <- scale(E(g_m)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
#E(g_m)$color <- obs_pair_mouthlicking$color
#V(g_m)$label.cex <- 1.2
V(g_m)$label.color <- "black"
#V(g_m)$label.family <- "sans"
V(g_m)$shape = recode(V(g_m)$sex, F= "circle", M = "rectangle")
#V(g_m)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_m) #layout_with_kk(g_m) # layout_with_drl(g_m)  

#graph_attr(g_m)

#plotting

#saving plot
svg("mouthlicking_network.svg", 7, 7)
#png("mouthlicking_network.png", 600, 600)

mouthlicking_network <- 
      plot(g_m,
     layout= layout,
     vertex.label.dist = 2.2,
    # label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_m)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

mouthlicking_network 
 



#play with different package, visnetwork, later. 
visIgraph(g_m)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_m), file = "full_mouthlicking.html")

to_vis <- toVisNetworkData(g_m)
mouth_nodes <- to_vis$nodes
mouth_edges <- to_vis$edges
width <- mouth_edges$width
mouth_nodes <- mouth_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
mouth_edges <- mouth_edges %>% select(!width)
visNetwork_try <- visNetwork(mouth_nodes, mouth_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

visIgraph(

# other network things 
degree(g_m) #degree
# evcent(g_m) #eigenvector centrality
edge_betweenness(g_m) #betweenness centrality: centrality to the network, shortest distance between conntections
#page_rank()







#goals: color by group
#weight edges by # mouthed
#make spacing better
#make font better
#graph_from_adjacency_matrix?
#obs pair before date
#obs pair after date
#mouthlicking, mouthlicking aggression


```
#mouthlicking pre-merge
```{r}

#mouthlicking all 
vamp_matrix_mouthlicking_premerge <- a_b_edgelist_to_matrix( a= obs_pair_mouthlicking_premerge$actor_name, r= obs_pair_mouthlicking_premerge$receiver_name, y=obs_pair_mouthlicking_premerge$n) #EL here is obs_pair..

vamp_matrix_mouthlicking_premerge
write.csv(vamp_matrix_mouthlicking_premerge, paste("vamp_matrix_mouthlicking_premerge",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_mouthlicking_premerge <- 
      obs_pair_mouthlicking_premerge %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 


#maybe I need to delete the 0 values? 
obs_pair_mouthlicking_premerge_nozero <- obs_pair_mouthlicking_premerge %>%
      filter(n!=0) #remove edges that don't exist


g_m_pre <- graph_from_data_frame(obs_pair_mouthlicking_premerge_nozero, directed = TRUE) #can change to 
V(g_m_pre) #get all vertices
V(g_m_pre)$group <- bat_groups$group
V(g_m_pre)$color <- bat_groups$color
V(g_m_pre)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_m_pre)$name) #14
V(g_m_pre)$sex[match(c("maui22"), V(g_m_pre)$name)] <- "M" # match(c("maui22"), V(g_m_pre)$name) pulls Maui
V(g_m_pre)$sex[match(c("ube22"), V(g_m_pre)$name)] <- "M"
#E(g_m_pre)$width <- scale(E(g_m_pre)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_m_pre)$color <- obs_pair_mouthlicking_premerge_nozero$color
V(g_m_pre)$label.cex <- 1.2
V(g_m_pre)$label.color <- "black"
#V(g_m_pre)$label.family <- "sans"
V(g_m_pre)$shape = recode(V(g_m_pre)$sex, F= "circle", M = "rectangle")
#V(g_m_pre)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_m_pre) #layout_with_kk(g_m_pre) # layout_with_drl(g_m_pre)  

#graph_attr(g_m_pre)

#plotting

#saving plot
svg("mouthlicking_network_premerge.svg", 7, 7)
#png("mouthlicking_network_premerge.png", 600, 600)

mouthlicking_network_premerge <- 
      plot(g_m_pre,
     layout= layout,
     vertex.label.dist = 2.2,
    # label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_m_pre)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

mouthlicking_network_premerge 
 



#play with different package, visnetwork, later. 
visIgraph(g_m_pre)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_m_pre), file = "mouthlicking_premerge.html") 

# to_vis <- toVisNetworkData(g_m_pre)
# mouth_nodes <- to_vis$nodes
# mouth_edges <- to_vis$edges
# width <- mouth_edges$width
# mouth_nodes <- mouth_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
# mouth_edges <- mouth_edges %>% select(!width)
# visNetwork_try <- visNetwork(mouth_nodes, mouth_edges)
# saveWidget(visNetwork_try, file= "visNetworktry.html")

```



#mouthlicking post-merge
```{r}

#mouthlicking all 
vamp_matrix_mouthlicking_postmerge <- a_b_edgelist_to_matrix( a= obs_pair_mouthlicking_postmerge$actor_name, r= obs_pair_mouthlicking_postmerge$receiver_name, y=obs_pair_mouthlicking_postmerge$n) #EL here is obs_pair..

vamp_matrix_mouthlicking_postmerge
write.csv(vamp_matrix_mouthlicking_postmerge, paste("vamp_matrix_mouthlicking_postmerge",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_mouthlicking_postmerge <- 
      obs_pair_mouthlicking_postmerge %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 


#maybe I need to delete the 0 values? 
obs_pair_mouthlicking_postmerge_nozero <- obs_pair_mouthlicking_postmerge %>%
      filter(n!=0) #remove edges that don't exist


g_m_post <- graph_from_data_frame(obs_pair_mouthlicking_postmerge_nozero, directed = TRUE) #can change to 
V(g_m_post) #get all vertices
V(g_m_post)$group <- bat_groups$group
V(g_m_post)$color <- bat_groups$color
V(g_m_post)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_m_post)$name) #14
V(g_m_post)$sex[match(c("maui22"), V(g_m_post)$name)] <- "M" # match(c("maui22"), V(g_m_post)$name) pulls Maui
V(g_m_post)$sex[match(c("ube22"), V(g_m_post)$name)] <- "M"
#E(g_m_post)$width <- scale(E(g_m_post)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_m_post)$color <- obs_pair_mouthlicking_postmerge_nozero$color
V(g_m_post)$label.cex <- 1.2
V(g_m_post)$label.color <- "black"
#V(g_m_post)$label.family <- "sans"
V(g_m_post)$shape = recode(V(g_m_post)$sex, F= "circle", M = "rectangle")
#V(g_m_post)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_m_post) #layout_with_kk(g_m_post) # layout_with_drl(g_m_post)  

#graph_attr(g_m_post)

#plotting

#saving plot
svg("mouthlicking_network_postmerge.svg", 7, 7)
#png("mouthlicking_network_postmerge.png", 600, 600)

mouthlicking_network_postmerge <- 
      plot(g_m_post,
     layout= layout,
     vertex.label.dist = 2.2,
      #vertex.label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_m_post)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

mouthlicking_network_postmerge 
 



#play with different package, visnetwork, later. 
visIgraph(g_m_post)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_m_post), file = "mouthlicking_postmerge.html")

to_vis <- toVisNetworkData(g_m_post)
mouth_nodes <- to_vis$nodes
mouth_edges <- to_vis$edges
width <- mouth_edges$width
mouth_nodes <- mouth_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
mouth_edges <- mouth_edges %>% select(!width)
visNetwork_try <- visNetwork(mouth_nodes, mouth_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

```


#aggression
## aggression total
```{r, matrix}
####
#try to see if it is possible to feed a lit of all bats , even if 0 observances of behavior in that bat

#aggression all 
vamp_matrix_aggression <- a_b_edgelist_to_matrix( a= obs_pair_aggression$actor_name, r= obs_pair_aggression$receiver_name, y=obs_pair_aggression$n ) #EL here is obs_pair..
vamp_matrix_aggression
write.csv(vamp_matrix_aggression, paste("vamp_matrix_aggression",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_aggression <- 
      obs_pair_aggression %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 
 
unique(obs_pair_aggression$actor_name)
  

#need to delete extras to make it fit hwen plotting (edge_colors_zero <- filter(n!=0 )), and keep only the color column


#maybe I need to delete the 0 values? 
obs_pair_aggression_nozero <- obs_pair_aggression %>%
      filter(n!=0) #remove edges that don't exist


g_a <- graph_from_data_frame(obs_pair_aggression_nozero, directed = TRUE) #can change to 
V(g_a) #get all vertices
V(g_a)$group <- bat_groups$group
V(g_a)$color <- bat_groups$color
V(g_a)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_a)$name) #14
V(g_a)$sex[match(c("maui22"), V(g_a)$name)] <- "M" # match(c("maui22"), V(g_a)$name) pulls Maui
V(g_a)$sex[match(c("ube22"), V(g_a)$name)] <- "M"
#E(g_a)$width <- scale(E(g_a)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
#E(g_a)$color <- obs_pair_aggression$color
#V(g_a)$label.cex <- 1.2
V(g_a)$label.color <- "black"
#V(g_a)$label.family <- "sans"
V(g_a)$shape = recode(V(g_a)$sex, F= "circle", M = "rectangle")
#V(g_a)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_a) #layout_with_kk(g_a) # layout_with_drl(g_a)  

#graph_attr(g_a)

#plotting

#saving plot
svg("aggression_network.svg", 7, 7)
#png("aggression_network.png", 600, 600)

aggression_network <- 
      plot(g_a,
     layout= layout,
     vertex.label.dist = 2.2,
    # label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_a)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

aggression_network 
 



#play with different package, visnetwork, later. 
visIgraph(g_a)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_a), file = "full_aggression.html")

to_vis <- toVisNetworkData(g_a)
agro_nodes <- to_vis$nodes
agro_edges <- to_vis$edges
width <- agro_edges$width
agro_nodes <- agro_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
agro_edges <- agro_edges %>% select(!width)
visNetwork_try <- visNetwork(agro_nodes, agro_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

visIgraph(

# other network things 
degree(g_a) #degree
# evcent(g_a) #eigenvector centrality
edge_betweenness(g_a) #betweenness centrality: centrality to the network, shortest distance between conntections
#page_rank()







#goals: color by group
#weight edges by # agroed
#make spacing better
#make font better
#graph_from_adjacency_matrix?
#obs pair before date
#obs pair after date
#aggression, aggression aggression


```
#aggression pre-merge
```{r}

#aggression all 
vamp_matrix_aggression_premerge <- a_b_edgelist_to_matrix( a= obs_pair_aggression_premerge$actor_name, r= obs_pair_aggression_premerge$receiver_name, y=obs_pair_aggression_premerge$n) #EL here is obs_pair..

vamp_matrix_aggression_premerge
write.csv(vamp_matrix_aggression_premerge, paste("vamp_matrix_aggression_premerge",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_aggression_premerge <- 
      obs_pair_aggression_premerge %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 


#maybe I need to delete the 0 values? 
obs_pair_aggression_premerge_nozero <- obs_pair_aggression_premerge %>%
      filter(n!=0) #remove edges that don't exist


g_a_pre <- graph_from_data_frame(obs_pair_aggression_premerge_nozero, directed = TRUE) #can change to 
V(g_a_pre) #get all vertices
V(g_a_pre)$group <- bat_groups$group
V(g_a_pre)$color <- bat_groups$color
V(g_a_pre)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_a_pre)$name) #14
V(g_a_pre)$sex[match(c("maui22"), V(g_a_pre)$name)] <- "M" # match(c("maui22"), V(g_a_pre)$name) pulls Maui
V(g_a_pre)$sex[match(c("ube22"), V(g_a_pre)$name)] <- "M"
#E(g_a_pre)$width <- scale(E(g_a_pre)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_a_pre)$color <- obs_pair_aggression_premerge_nozero$color
V(g_a_pre)$label.cex <- 1.2
V(g_a_pre)$label.color <- "black"
#V(g_a_pre)$label.family <- "sans"
V(g_a_pre)$shape = recode(V(g_a_pre)$sex, F= "circle", M = "rectangle")
#V(g_a_pre)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_a_pre) #layout_with_kk(g_a_pre) # layout_with_drl(g_a_pre)  

#graph_attr(g_a_pre)

#plotting

#saving plot
svg("aggression_network_premerge.svg", 7, 7)
#png("aggression_network_premerge.png", 600, 600)

aggression_network_premerge <- 
      plot(g_a_pre,
     layout= layout,
     vertex.label.dist = 2.2,
    # label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_a_pre)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

aggression_network_premerge 
 



#play with different package, visnetwork, later. 
visIgraph(g_a_pre)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_a_pre), file = "aggression_premerge.html") 

to_vis <- toVisNetworkData(g_a_pre)
agro_nodes <- to_vis$nodes
agro_edges <- to_vis$edges
width <- agro_edges$width
agro_nodes <- agro_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
agro_edges <- agro_edges %>% select(!width)
visNetwork_try <- visNetwork(agro_nodes, agro_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

```



#aggression post-merge
```{r}

#aggression all 
vamp_matrix_aggression_postmerge <- a_b_edgelist_to_matrix( a= obs_pair_aggression_postmerge$actor_name, r= obs_pair_aggression_postmerge$receiver_name, y=obs_pair_aggression_postmerge$n) #EL here is obs_pair..

vamp_matrix_aggression_postmerge
write.csv(vamp_matrix_aggression_postmerge, paste("vamp_matrix_aggression_postmerge",  ".csv", sep = ""))



#######
#attempt t make own plot with 3 colors 

#add same colors as actor colors in bat_groups to obs_pair if you want edges to have them
obs_pair_aggression_postmerge <- 
      obs_pair_aggression_postmerge %>%
      left_join(bat_groups, by = c( "actor_name"= "bat_name_full")) %>% 
      select(!group) 


#maybe I need to delete the 0 values? 
obs_pair_aggression_postmerge_nozero <- obs_pair_aggression_postmerge %>%
      filter(n!=0) #remove edges that don't exist


g_a_post <- graph_from_data_frame(obs_pair_aggression_postmerge_nozero, directed = TRUE) #can change to 
V(g_a_post) #get all vertices
V(g_a_post)$group <- bat_groups$group
V(g_a_post)$color <- bat_groups$color
V(g_a_post)$sex <- "F" #sex, need to correct for 2 males, next line
match(c("maui22"), V(g_a_post)$name) #14
V(g_a_post)$sex[match(c("maui22"), V(g_a_post)$name)] <- "M" # match(c("maui22"), V(g_a_post)$name) pulls Maui
V(g_a_post)$sex[match(c("ube22"), V(g_a_post)$name)] <- "M"
#E(g_a_post)$width <- scale(E(g_a_post)$n, center = FALSE)   #edge width, scaled #can do this in plotting as well 
E(g_a_post)$color <- obs_pair_aggression_postmerge_nozero$color
V(g_a_post)$label.cex <- 1.2
V(g_a_post)$label.color <- "black"
#V(g_a_post)$label.family <- "sans"
V(g_a_post)$shape = recode(V(g_a_post)$sex, F= "circle", M = "rectangle")
#V(g_a_post)$label.dist = 2.2




#layout term determines the organization, can play with the options
layout <-layout_nicely(g_a_post) #layout_with_kk(g_a_post) # layout_with_drl(g_a_post)  

#graph_attr(g_a_post)

#plotting

#saving plot
svg("aggression_network_postmerge.svg", 7, 7)
#png("aggression_network_postmerge.png", 600, 600)

aggression_network_postmerge <- 
      plot(g_a_post,
     layout= layout,
     vertex.label.dist = 2.2,
      #vertex.label.cex <- 1.2,
     vertex.label.family = "sans",
    edge.width = scale(E(g_a_post)$n, center= FALSE),
    #edge.color = "black", 
    edge.arrow.size = .5
    
     ) #main = "Title"

dev.off() #end of printing 

aggression_network_postmerge 
 



#play with different package, visnetwork, later. 
visIgraph(g_a_post)
#save as visplot so it's prettier 

saveWidget(visIgraph(g_a_post), file = "aggression_postmerge.html")

to_vis <- toVisNetworkData(g_a_post)
agro_nodes <- to_vis$nodes
agro_edges <- to_vis$edges
width <- agro_edges$width
agro_nodes <- agro_nodes %>% select( !font.size, !font.color, !label.family, !label.dist)
agro_edges <- agro_edges %>% select(!width)
visNetwork_try <- visNetwork(agro_nodes, agro_edges)
saveWidget(visNetwork_try, file= "visNetworktry.html")

```


```{r}

#mouthlicking
vamp_matrix_mouthlicking <- a_b_edgelist_to_matrix( a= obs_pair_mouthlicking$l_actor_name, r= obs_pair_mouthlicking$l_receiver_name, y=obs_pair_mouthlicking$n ) #EL here is obs_pair..
vamp_matrix_mouthlicking
write.csv(vamp_matrix_mouthlicking, paste("vamp_matrix_mouthlicking",  ".csv", sep = ""))

#aggression
vamp_matrix_aggression <- a_b_edgelist_to_matrix( a= obs_pair_aggression$l_actor_name, r= obs_pair_aggression$l_receiver_name, y=obs_pair_aggression$n ) #EL here is obs_pair..
vamp_matrix_aggression
write.csv(vamp_matrix_aggression, paste("vamp_matrix_aggression",  ".csv", sep = ""))




#separate matrix by group
# dolly bea alanis,cher, dolly, helen, judy, fergie, luna, manon, nelly

MakeEdgeLists <- function(EL = data, behavior = "g") {
EL_list <- 
      EL %>%
      filter(group!="NA") %>% #remove any NA observations
      ungroup() %>%
      group_split(group)
names(EL_list) <- c("EL_Bayano", "EL_Chorrera", "EL_Tole") #name each item in the list
list2env(EL_list, envir = .GlobalEnv) #put these names in the global environment
    


Chorrera_matrix <-   a_b_edgelist_to_matrix( a= EL_Chorrera$actor_name, r= EL_Chorrera$receiver_name, y=EL_Chorrera$n, make.NA.zero = T)
Chorrera_matrix 

write.csv(Chorrera_matrix, paste0("matrix_",
                                   behavior,
                                  "_chorrera",
                                  format(Sys.time(), "%Y-%m-%d"),
                                  ".CSV"))
    

Tole_matrix <-   a_b_edgelist_to_matrix( a= EL_Tole$actor_name, r= EL_Tole$receiver_name, y=EL_Tole$n, make.NA.zero = T)
Tole_matrix 

write.csv(Tole_matrix , paste0("matrix_",
                                   behavior,
                                  "_tole",
                                  format(Sys.time(), "%Y-%m-%d"),
                                  ".CSV"))


Bayano_matrix <-   a_b_edgelist_to_matrix( a= EL_Bayano$actor_name, r= EL_Bayano$receiver_name, y=EL_Bayano$n, make.NA.zero = T)
Bayano_matrix 

write.csv(Bayano_matrix, paste0("matrix_",
                                   behavior,
                                  "_bayano",
                                  format(Sys.time(), "%Y-%m-%d"),
                                  ".CSV"))
}

MakeEdgeLists(obs_pair_grooming, behavior = "g")

MakeEdgeLists(obs_pair_mouthlicking, behavior = "m")

```

```{r corplots}
# ggcorplot


#obs_pair$actor_name <- reorder(obs_pair$actor_name , obs_pair$n)
obs_pair$receiver_name <- fct_relevel(obs_pair$receiver_name) #order both actor and receiver abc
obs_pair$actor_name <- fct_relevel(obs_pair$actor_name) 


obs_pair_matrix <- ggplot(data = obs_pair, aes(x=actor_name, y=receiver_name, fill=n)) + #
  geom_tile() +
      facet_wrap(~group, scales= "free", dir = "v") +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1)) +
       scale_fill_gradient2(low = "white", high = "red", 
   space = "Lab", 
   name="# grooming events") +
      geom_text(aes(x=actor_name, y=receiver_name, label = n), color = "black", size = 4) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank() ) #+
#xlim(levels(obs_pair$actor_name))

obs_pair_matrix 
#ggsave("obs_pair_matrix.jpg")
#quen? whover that is is dead
#move judy / analysis pair to chorrera

obs_pair %>%
     # filter(group== "Chorrera") %>%
      ggplot(data = ., aes(x=actor_name, y=receiver_name, fill=n)) + #
  geom_tile() +
      facet_wrap(~group, scales= "free", dir = "v") +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1)) +
       scale_fill_gradient2(low = "white", high = "red", 
   space = "Lab", 
   name="# grooming events") +
      geom_text(aes(x=actor_name, y=receiver_name, label = n), color = "black", size = 4) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank() )

#ggsave("chorrera_heatmap.jpg")


```

```{r}
     
       ggplot(data = v2022_allogr, aes(x=actor_name)) + #
      geom_bar() +
      facet_grid(rows = vars(actor_name), cols = vars(receiver_name), drop = FALSE)
```


```{r}
library(networkD3)

x<- v2022_allogr %>%
      #filter(behavior == "m" | behavior == "g") %>%
     # filter(group == "Bayano" | group == "Tolé") %>%
      group_by(group) %>%

simpleNetwork( height="100px", width="100px",        
        Source = 20,                 # column number of source
        Target = 21,                 # column number of target
        linkDistance = 50,          # distance between node. Increase this value to have more space between nodes
        charge = -50,                # numeric value indicating either the strength of the node repulsion (negative value) or attraction (positive value)
        fontSize = 14,               # size of the node names
        fontFamily = "sansserif",       # font og node names
        linkColour = "#666",        # colour of edges, MUST be a common colour for the whole graph
        nodeColour = "#69b3a2",     # colour of nodes, MUST be a common colour for the whole graph
        opacity = 0.9,              # opacity of nodes. 0=transparent. 1=no transparency
        zoom = T                    # Can you zoom on the figure?
        )   
x
#network with node size weighted by degree
network <- function(data, LabelNumber = 0.7) {
      network <-   data %>%
        filter(behavior == "m") %>%
      #filter(group == "Chorrera") %>%
        select(actor_name, receiver_name) %>%
# Turn it into igraph object
 graph_from_data_frame( directed=T) #d=links,
 
# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
plot <- plot(network,
      vertex.size=deg*.09,
     edge.arrow.size=.2, 
     edge.curved=.02,
     vertex.color="#F4E2B0", 
     vertex.frame.color="black",
     vertex.label.color= "black",
     edge.color = "black",
     fontFamily = "sans",
     vertex.label.cex=LabelNumber)     #vertex.size=deg*6, vertex.color=rgb(0.1,0.7,0.8,0.5)

plot
return(plot)
}
#"tan
"#A37841""
"#79603A"
"#F4E2B0"
"#413424"
#plot each group's network seperately
v2022_allogr %>%
      filter(group == "Chorrera" | group == "Tolé" |group == "Bayano" ) %>%
      group_by(group) %>%
      #group_split(group) %>%
      #map(~network(.))
      group_walk(~network(.))

vamp_2022_networks$plot

v2022_allogr %>%
      filter(group == "Chorrera") %>%
      network()
#ggsave("chorrera_network.jpg")

all_net <- v2022_allogr %>%
      network()
str(all_net)
#ggsave("full_network.jpg")



```




## Did bats that had met before groom or mouthlick faster than other bats? 


```{r}
obs_pair_mouthlicking_postmerge <- v2022_allogr %>%
      filter(date > "2024-06-26") %>%
       ObsMatrix(data = ., Behavior = "m") 
obs_pair_mouthlicking_postmerge<- rbind(missing, obs_pair_mouthlicking_postmerge) %>%
      complete(actor_name, receiver_name, fill = list(n=0)) #%>% #fill in missing combinations within group%>%
#filter(actor_name != receiver_name) 
```



