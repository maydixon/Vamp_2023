---
title: "Allogrooming data 2023"
output: html_notebook
---
# mean and minimum grooming events/ bat
# matrix where grooming actor is row and recipient is column, and the cell has the number of grooming. csv or excel is fine. I know you have these data because it's your heatmap.

### Libraries
```{r libraries}
library(readxl)
library(ggplot2)
library(dplyr)
library(Rcpp)
library(tidyverse)

```

### Load data
```{r load data}
# bat names and states
v2022_bats <- read_excel("2022_vampire_data.xlsx", sheet = "bats")
View(v2022_bats) 

# allogrooming data
v2022_allogr <- read_excel("2022_vampire_data.xlsx", 
    sheet = "Flight_cage", col_types = c("text", 
        "text", "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "text", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "skip"))

# View(v2022_allogr)  

```

### Cleaning 
```{r cleaning}


#make the text in actor and receiver lowercase (to match bat names)
v2022_allogr <- v2022_allogr %>% mutate(actor= tolower(actor), receiver = tolower(receiver)) 

#table with just the various bat names 
v2022_names <- v2022_bats %>% select(bat_name, formal_ID, new_formal_ID)


# rename to human readable names with year

      # add "juvenil" to v2022_names
v2022_names <- rbind(v2022_names, c("juvenil", "juvenil", "juvenil"))

      # add 22 to names (e.g. bea22)
v2022_names <- v2022_names %>% mutate(bat_name_full = paste0(bat_name, "22"))

      #make long version of names by the names I want 
nameslong <- v2022_names %>%
  gather(ID_type, IDS, c(bat_name, formal_ID, new_formal_ID), na.rm = TRUE) %>%
  arrange(bat_name_full)
View(nameslong)

      #join by actor to add actor names(match IDS and actor)
v2022_allogr <- v2022_allogr %>%
  left_join(nameslong, by = c("actor" = "IDS")) %>%
  select( - ID_type) %>%
      rename(actor_name = bat_name_full)
View(v2022_allogr)

      # join by receiver to add receiver names
v2022_allogr <- v2022_allogr %>%
  left_join(nameslong, by = c("receiver" = "IDS")) %>%
  select( - ID_type) %>%
      rename(receiver_name = bat_name_full)


#remove rows where actor or receiver is NA
v2022_allogr <- v2022_allogr %>%
      filter(!is.na(actor)) %>%
      filter(!is.na(receiver))

#clean  groupnames
v2022_allogr %>% select(group) %>% unique()

v2022_allogr <- v2022_allogr %>% mutate(group = recode(
      group,
      "c" = "Chorrera",
      "t" ="Tol√©",
      "b" = "Bayano"
))


# Find odd cases
# fix Judy appearing in wrong group

v2022_allogr <- v2022_allogr %>%
       mutate( group = replace(group, actor_name =="judy22", "Chorrera")) %>%
       mutate( group = replace(group, actor_name =="alanis22", "Chorrera")) 

```

### cleaning pt 2
```{r cleaning 2}

nrow(v2022_allogr) # # observations pre-cleaning

## remove rows where actor or receiver are NA
v2022_allogr <- v2022_allogr %>%
      filter(actor_name !="NA") %>%
      filter(receiver_name !="NA")

nrow(v2022_allogr) #1524 # observations with no NA

# remove rows where actor and receiver are the same 
v2022_allogr <- v2022_allogr[v2022_allogr$actor_name != v2022_allogr$receiver_name, ]



nrow(v2022_allogr) # 1359 # observations with no same receiver/actors

#observations without juveniles (not saves) #726
v2022_allogr %>% 
      filter(actor_name != "juvenil22") %>%
      filter(receiver_name != "juvenil22") %>% nrow() #observations with no juveniles

#Pull out names of living bats, no juveniles
living_bats <- 
      v2022_bats %>% select(bat_name, deceased_premerge) %>%
      filter( is.na(deceased_premerge)) %>%
      mutate(bat_name_full = paste0(bat_name, "22")) %>%
      select(-bat_name, -deceased_premerge) %>%
      filter(bat_name_full != "NA22") #removes juveniles, no names
       #keep only NA for deceased

# drop non-living bats, unnamed juveniles from grooming dataset
v2022_allogr <- 
      v2022_allogr %>%
      filter( actor_name %in% living_bats$bat_name_full) %>%
      filter( receiver_name %in% living_bats$bat_name_full) #%>%
      #filter(actor_name != "quen22" | actor_name != "olive22")
unique(v2022_allogr$actor_name)
unique(v2022_allogr$receiver_name)

nrow(v2022_allogr) #of observations with living bats alone
```

### Number of Observations per individual
```{r Obs per individual}

# of observations with usable data
nrow(v2022_allogr) 

# observations per individual by whether actor/ receiver/ interaction

obs_per_individual <- v2022_allogr %>%
      pivot_longer(
            cols= c(actor_name, receiver_name), 
            names_to = "interaction_role", 
            values_to = "subject"
      ) %>%
      relocate(subject, interaction_role) %>% 
          group_by(subject) %>%
      summarize (total= n(),
                 actor = sum(interaction_role=="actor_name"),
                 receiver = sum(interaction_role=="receiver_name"),
                 grooming = sum(behavior=="g", na.rm = TRUE),
                 mouthlicking = sum(behavior=="m", na.rm = TRUE),
                 aggression = sum(behavior=="X", na.rm = TRUE)
                 ) %>%
      arrange(-total)

obs_per_individual

#write.csv(obs_per_individual, file = "obs_per_individual.csv")

```

# matrix where grooming actor is row and recipient is column, and the cell has the number of grooming. csv or excel is fine. I know you have these data because it's your heatmap.

#Observation matrix
```{r obs matrix}
#  create matrix of # observations from each actor and receiver
obs_pair <- v2022_allogr %>% group_by(actor_name,receiver_name, group) %>% summarise(n = n()) %>% arrange(-n)

      
      # or : v2022_allogr %>% count(actor,receiver )


#write.csv(obs_pair, file = "observations_pairs.csv")

# arrange by group
(obs_pair <- obs_pair %>%
      arrange(group))





obs_pair_living <- v2022_allogr %>% group_by(actor_name,receiver_name, group) %>% summarise(n = n())
obs_pair_living 

```

```{r corplots}
# ggcorplot
library(ggplot2)

obs_pair_living$actor_name <- reorder(obs_pair_living$actor_name , obs_pair_living$n)

obs_pair_matrix <- ggplot(data = obs_pair_living, aes(x=actor_name, y=receiver_name, fill=n)) + #
  geom_tile() +facet_wrap(~group, scales= "free", dir = "v") +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1)) +
       scale_fill_gradient2(low = "white", high = "red", 
   space = "Lab", 
   name="# grooming events") +
      geom_text(aes(x=actor_name, y=receiver_name, label = n), color = "black", size = 4) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank() )

obs_pair_matrix 
ggsave("obs_pair_matrix.jpg")
#quen? whover that is is dead
#move judy / analysis pair to chorrera


```



